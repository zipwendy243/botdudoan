import os
import logging
from datetime import datetime, timedelta
from openai import OpenAI
from language_service import LanguageService

logger = logging.getLogger(__name__)

class PredictionService:
    def __init__(self):
        """Initialize the prediction service with OpenAI client."""
        self.openai_api_key = os.environ.get("OPENAI_API_KEY")
        if not self.openai_api_key:
            raise ValueError("OPENAI_API_KEY environment variable is not set")
        
        # Initialize OpenAI client
        self.openai = OpenAI(api_key=self.openai_api_key)
        
        # Initialize language service
        self.language_service = LanguageService()
        
        # Store predictions for different lottery types with their timestamps and languages
        # Format: {lottery_type: {language_code: {'prediction': text, 'date': date}}}
        self.predictions = {
            'vietnam': {
                'vi': {'prediction': None, 'date': None},
                'en': {'prediction': None, 'date': None},
                'th': {'prediction': None, 'date': None},
                'zh': {'prediction': None, 'date': None}
            },
            '4d': {
                'vi': {'prediction': None, 'date': None},
                'en': {'prediction': None, 'date': None},
                'th': {'prediction': None, 'date': None},
                'zh': {'prediction': None, 'date': None}
            },
            'thai': {
                'vi': {'prediction': None, 'date': None},
                'en': {'prediction': None, 'date': None},
                'th': {'prediction': None, 'date': None},
                'zh': {'prediction': None, 'date': None}
            },
            'indo': {
                'vi': {'prediction': None, 'date': None},
                'en': {'prediction': None, 'date': None},
                'th': {'prediction': None, 'date': None},
                'zh': {'prediction': None, 'date': None}
            }
        }
        
        # Log initialization
        logger.info("Prediction service initialized and ready to generate random lottery predictions")

    def generate_vietnam_prediction(self, language_code='vi'):
        """
        Generate a new Vietnam lottery prediction using OpenAI's GPT-4o Mini model.
        
        Args:
            language_code (str): The language code to generate the prediction in
            
        Returns:
            str: The formatted prediction text in the requested language
        """
        try:
            # Get the current date for reference in the prompt
            today = datetime.now().strftime("%d/%m/%Y")
            
            # Define system and user prompts for different languages
            prompts = {
                'vi': {
                    'system': "B·∫°n l√† m·ªôt chuy√™n gia d·ª± ƒëo√°n x·ªï s·ªë Vi·ªát Nam v·ªõi nhi·ªÅu nƒÉm kinh nghi·ªám. Cung c·∫•p nh·ªØng d·ª± ƒëo√°n ch√≠nh x√°c v√† h·ªØu √≠ch cho ng∆∞·ªùi ch∆°i. Lu√¥n t·∫°o c√°c s·ªë x·ªï s·ªë ng·∫´u nhi√™n, kh√¥ng theo m·∫´u, c√°c s·ªë gi·∫£i ƒë·∫∑c bi·ªát ph·∫£i l√† 6 ch·ªØ s·ªë ng·∫´u nhi√™n th·ª±c s·ª± (nh∆∞ 578421, 309764) v√† c√°c c·∫∑p s·ªë may m·∫Øn l√† 2 ch·ªØ s·ªë ng·∫´u nhi√™n (nh∆∞ 35, 72, 19). Tuy·ªát ƒë·ªëi kh√¥ng ƒë∆∞a ra c√°c s·ªë theo tu·∫ßn t·ª± ho·∫∑c m·∫´u ƒë∆°n gi·∫£n nh∆∞ 123456.",
                    'user': f"""
                    H√£y ƒë∆∞a ra d·ª± ƒëo√°n x·ªï s·ªë Vi·ªát Nam cho ng√†y {today} cho c·∫£ ba mi·ªÅn: B·∫Øc, Trung, Nam v·ªõi c√°c s·ªë ng·∫´u nhi√™n, kh√¥ng s·ª≠ d·ª•ng m·∫´u s·ªë ƒë∆°n gi·∫£n nh∆∞ 123456.
                    
                    D·ª± ƒëo√°n c·∫ßn bao g·ªìm:
                    1. Mi·ªÅn B·∫Øc: Gi·∫£i ƒë·∫∑c bi·ªát (6 ch·ªØ s·ªë ng·∫´u nhi√™n) v√† 3-5 c·∫∑p s·ªë may m·∫Øn (2 ch·ªØ s·ªë m·ªói c·∫∑p)
                    2. Mi·ªÅn Trung: Gi·∫£i ƒë·∫∑c bi·ªát (6 ch·ªØ s·ªë ng·∫´u nhi√™n) v√† 3-5 c·∫∑p s·ªë may m·∫Øn (2 ch·ªØ s·ªë m·ªói c·∫∑p) 
                    3. Mi·ªÅn Nam: Gi·∫£i ƒë·∫∑c bi·ªát (6 ch·ªØ s·ªë ng·∫´u nhi√™n) v√† 3-5 c·∫∑p s·ªë may m·∫Øn (2 ch·ªØ s·ªë m·ªói c·∫∑p)
                    
                    QUAN TR·ªåNG: 
                    - S·ªë gi·∫£i ƒë·∫∑c bi·ªát ph·∫£i l√† 6 ch·ªØ s·ªë ng·∫´u nhi√™n (v√≠ d·ª•: 651429, 783052, 247916)
                    - M·ªói c·∫∑p s·ªë may m·∫Øn ph·∫£i l√† 2 ch·ªØ s·ªë ng·∫´u nhi√™n (v√≠ d·ª•: 26, 83, 57, 14, 90)
                    - KH√îNG ƒë∆∞·ª£c s·ª≠ d·ª•ng c√°c m·∫´u s·ªë ƒë∆°n gi·∫£n v√† d·ªÖ ƒëo√°n nh∆∞ 123456, 111111, 222222, v.v.
                    - M·ªói b·ªô s·ªë ph·∫£i ho√†n to√†n ng·∫´u nhi√™n v√† kh√°c nhau
                    
                    S·ª≠ d·ª•ng gi·ªçng ƒëi·ªáu t·ª± nhi√™n, th√¢n thi·ªán v√† h·∫•p d·∫´n b·∫±ng ti·∫øng Vi·ªát. Th√™m m·ªôt v√†i l∆∞u √Ω nh·ªè ho·∫∑c m·∫πo v·ªÅ c√°ch ƒë·∫∑t c∆∞·ª£c th√¥ng minh.
                    
                    Format response in clear, readable Vietnamese with appropriate line breaks and emphasis.
                    """,
                    'header': f"<b>üéØ D·ª∞ ƒêO√ÅN X·ªî S·ªê VI·ªÜT NAM NG√ÄY {today} üéØ</b>",
                    'footer': "<i>Ch√∫c b·∫°n may m·∫Øn! H√£y nh·ªõ ƒë·∫∑t c∆∞·ª£c c√≥ tr√°ch nhi·ªám.</i>"
                },
                'en': {
                    'system': "You are a Vietnamese lottery prediction expert with many years of experience. Provide accurate and helpful predictions for players. Always generate random lottery numbers without patterns. Special prizes must be truly random 6-digit numbers (like 578421, 309764) and lucky pairs must be random 2-digit numbers (like 35, 72, 19). Never provide sequential numbers or simple patterns like 123456.",
                    'user': f"""
                    Provide Vietnam lottery predictions for {today} for all three regions: North, Central, and South, using random numbers without simple patterns like 123456.
                    
                    The prediction should include:
                    1. North region: Special prize (6 random digits) and 3-5 lucky number pairs (2 digits each)
                    2. Central region: Special prize (6 random digits) and 3-5 lucky number pairs (2 digits each)
                    3. South region: Special prize (6 random digits) and 3-5 lucky number pairs (2 digits each)
                    
                    IMPORTANT:
                    - Special prize numbers must be 6 random digits (e.g., 651429, 783052, 247916)
                    - Each lucky pair must be 2 random digits (e.g., 26, 83, 57, 14, 90)
                    - DO NOT use simple and predictable patterns like 123456, 111111, 222222, etc.
                    - Each set of numbers must be completely random and different from each other
                    
                    Use a natural, friendly, and engaging tone in English. Add a few small notes or tips on smart betting strategies.
                    
                    Format response in clear, readable English with appropriate line breaks and emphasis.
                    """,
                    'header': f"<b>üéØ VIETNAM LOTTERY PREDICTION FOR {today} üéØ</b>",
                    'footer': "<i>Good luck! Remember to bet responsibly.</i>"
                },
                'th': {
                    'system': "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏™‡∏•‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏•‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏°‡∏≠‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô 578421, 309764) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° (‡πÄ‡∏ä‡πà‡∏ô 35, 72, 19) ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏ä‡πà‡∏ô 123456",
                    'user': f"""
                    ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏™‡∏•‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {today} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≤‡∏°‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ: ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠, ‡∏Å‡∏•‡∏≤‡∏á, ‡πÅ‡∏•‡∏∞‡πÉ‡∏ï‡πâ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏ä‡πà‡∏ô 123456
                    
                    ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢:
                    1. ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠: ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏© (6 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡πà‡∏°) ‡πÅ‡∏•‡∏∞ 3-5 ‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡∏Ç‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ (2 ‡∏´‡∏•‡∏±‡∏Å‡∏ï‡πà‡∏≠‡∏Ñ‡∏π‡πà)
                    2. ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á: ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏© (6 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡πà‡∏°) ‡πÅ‡∏•‡∏∞ 3-5 ‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡∏Ç‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ (2 ‡∏´‡∏•‡∏±‡∏Å‡∏ï‡πà‡∏≠‡∏Ñ‡∏π‡πà)
                    3. ‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ: ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏© (6 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡πà‡∏°) ‡πÅ‡∏•‡∏∞ 3-5 ‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡∏Ç‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ (2 ‡∏´‡∏•‡∏±‡∏Å‡∏ï‡πà‡∏≠‡∏Ñ‡∏π‡πà)
                    
                    ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
                    - ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 6 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° (‡πÄ‡∏ä‡πà‡∏ô 651429, 783052, 247916)
                    - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° (‡πÄ‡∏ä‡πà‡∏ô 26, 83, 57, 14, 90)
                    - ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≤‡∏î‡πÄ‡∏î‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πà‡∏ô 123456, 111111, 222222 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
                    - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô
                    
                    ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏ç‡∏â‡∏•‡∏≤‡∏î
                    
                    ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                    """,
                    'header': f"<b>üéØ ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏™‡∏•‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {today} üéØ</b>",
                    'footer': "<i>‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</i>"
                },
                'zh': {
                    'system': "ÊÇ®ÊòØ‰∏Ä‰ΩçÊã•ÊúâÂ§öÂπ¥ÁªèÈ™åÁöÑË∂äÂçóÂΩ©Á•®È¢ÑÊµã‰∏ìÂÆ∂„ÄÇ‰∏∫Áé©ÂÆ∂Êèê‰æõÂáÜÁ°ÆÊúâÁî®ÁöÑÈ¢ÑÊµã„ÄÇÂßãÁªàÁîüÊàêÊ≤°ÊúâËßÑÂæãÁöÑÈöèÊú∫ÂΩ©Á•®Âè∑Á†Å„ÄÇÁâπÂà´Â•ñÂøÖÈ°ªÊòØÁúüÊ≠£ÈöèÊú∫ÁöÑ6‰ΩçÊï∞Â≠óÔºàÂ¶Ç578421„ÄÅ309764ÔºâÔºåÂπ∏ËøêÂØπÂøÖÈ°ªÊòØÈöèÊú∫ÁöÑ2‰ΩçÊï∞Â≠óÔºàÂ¶Ç35„ÄÅ72„ÄÅ19Ôºâ„ÄÇÂàáÂãøÊèê‰æõËøûÁª≠Êï∞Â≠óÊàñÁÆÄÂçïÊ®°ÂºèÔºåÂ¶Ç123456„ÄÇ",
                    'user': f"""
                    Êèê‰æõ{today}Êó•Ë∂äÂçóÂΩ©Á•®È¢ÑÊµãÔºåÂåÖÊã¨ÂåóÈÉ®„ÄÅ‰∏≠ÈÉ®ÂíåÂçóÈÉ®‰∏â‰∏™Âú∞Âå∫Ôºå‰ΩøÁî®ÈöèÊú∫Êï∞Â≠óÔºåÈÅøÂÖç‰ΩøÁî®ÂÉè123456ËøôÊ†∑ÁöÑÁÆÄÂçïÊ®°Âºè„ÄÇ
                    
                    È¢ÑÊµãÂ∫îÂåÖÊã¨Ôºö
                    1. ÂåóÈÉ®Âú∞Âå∫ÔºöÁâπÂà´Â•ñÔºà6‰ΩçÈöèÊú∫Êï∞Â≠óÔºâÂíå3-5ÂØπÂπ∏ËøêÊï∞Â≠óÔºàÊØèÂØπ2‰ΩçÊï∞Â≠óÔºâ
                    2. ‰∏≠ÈÉ®Âú∞Âå∫ÔºöÁâπÂà´Â•ñÔºà6‰ΩçÈöèÊú∫Êï∞Â≠óÔºâÂíå3-5ÂØπÂπ∏ËøêÊï∞Â≠óÔºàÊØèÂØπ2‰ΩçÊï∞Â≠óÔºâ
                    3. ÂçóÈÉ®Âú∞Âå∫ÔºöÁâπÂà´Â•ñÔºà6‰ΩçÈöèÊú∫Êï∞Â≠óÔºâÂíå3-5ÂØπÂπ∏ËøêÊï∞Â≠óÔºàÊØèÂØπ2‰ΩçÊï∞Â≠óÔºâ
                    
                    ÈáçË¶ÅÊèêÁ§∫Ôºö
                    - ÁâπÂà´Â•ñÂè∑Á†ÅÂøÖÈ°ªÊòØ6‰ΩçÈöèÊú∫Êï∞Â≠óÔºà‰æãÂ¶ÇÔºö651429„ÄÅ783052„ÄÅ247916Ôºâ
                    - ÊØèÂØπÂπ∏ËøêÊï∞Â≠óÂøÖÈ°ªÊòØ2‰ΩçÈöèÊú∫Êï∞Â≠óÔºà‰æãÂ¶ÇÔºö26„ÄÅ83„ÄÅ57„ÄÅ14„ÄÅ90Ôºâ
                    - ‰∏çË¶Å‰ΩøÁî®ÁÆÄÂçïÂíåÂèØÈ¢ÑÊµãÁöÑÊ®°ÂºèÔºåÂ¶Ç123456„ÄÅ111111„ÄÅ222222Á≠â
                    - ÊØèÁªÑÊï∞Â≠óÂøÖÈ°ªÂÆåÂÖ®ÈöèÊú∫‰∏îÂΩºÊ≠§‰∏çÂêå
                    
                    ‰ΩøÁî®Ëá™ÁÑ∂„ÄÅÂèãÂ•ΩÂíåÂê∏Âºï‰∫∫ÁöÑ‰∏≠ÊñáËØ≠Ë∞É„ÄÇÊ∑ªÂä†‰∏Ä‰∫õÂÖ≥‰∫éÊô∫ËÉΩÊäïÊ≥®Á≠ñÁï•ÁöÑÂ∞èÊèêÁ§∫„ÄÇ
                    
                    ‰ª•Ê∏ÖÊô∞„ÄÅÊòìËØªÁöÑ‰∏≠ÊñáÊ†ºÂºèÂõûÂ∫îÔºå‰ΩøÁî®ÈÄÇÂΩìÁöÑÊç¢Ë°åÂíåÂº∫Ë∞É„ÄÇ
                    """,
                    'header': f"<b>üéØ {today}Ë∂äÂçóÂΩ©Á•®È¢ÑÊµã üéØ</b>",
                    'footer': "<i>Á•ùÊÇ®Â•ΩËøêÔºÅËØ∑ËÆ∞ÂæóË¥üË¥£‰ªªÂú∞ÊäïÊ≥®„ÄÇ</i>"
                }
            }
            
            # Check if language is supported
            if language_code not in prompts:
                logger.warning(f"Language {language_code} not supported for predictions, using Vietnamese")
                language_code = 'vi'
                
            # Get prompts for the requested language
            selected_prompts = prompts[language_code]
            
            # the newest OpenAI model is "gpt-4o" which was released May 13, 2024.
            # do not change this unless explicitly requested by the user
            response = self.openai.chat.completions.create(
                model="gpt-4o-mini",  # Using GPT-4o Mini as specified in requirements
                messages=[
                    {"role": "system", "content": selected_prompts['system']},
                    {"role": "user", "content": selected_prompts['user']}
                ],
                max_tokens=1000
            )
            
            prediction_text = response.choices[0].message.content
            
            # Format the prediction with a header and footer in the requested language
            formatted_prediction = f"""
{selected_prompts['header']}

{prediction_text}

{selected_prompts['footer']}
"""
            
            logger.info(f"Generated new Vietnam prediction in {language_code} for {today}")
            return formatted_prediction
            
        except Exception as e:
            logger.error(f"Error generating Vietnam prediction in {language_code}: {e}")
            error_messages = {
                'vi': f"‚ùå ƒê√£ x·∫£y ra l·ªói khi t·∫°o d·ª± ƒëo√°n. Vui l√≤ng th·ª≠ l·∫°i sau. Error: {str(e)}",
                'en': f"‚ùå An error occurred while generating the prediction. Please try again later. Error: {str(e)}",
                'th': f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}",
                'zh': f"‚ùå ÁîüÊàêÈ¢ÑÊµãÊó∂Âá∫Èîô„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇÈîôËØØÔºö{str(e)}"
            }
            return error_messages.get(language_code, error_messages['vi'])

    def generate_4d_prediction(self, language_code='vi'):
        """
        Generate a new 4D lottery prediction (Singapore/Malaysia).
        
        Args:
            language_code (str): The language code to generate the prediction in
            
        Returns:
            str: The formatted prediction text in the requested language
        """
        try:
            # Get the current date for reference in the prompt
            today = datetime.now().strftime("%d/%m/%Y")
            
            # Define system and user prompts for different languages
            prompts = {
                'vi': {
                    'system': "B·∫°n l√† chuy√™n gia d·ª± ƒëo√°n x·ªï s·ªë 4D Singapore/Malaysia v·ªõi nhi·ªÅu nƒÉm kinh nghi·ªám. H√£y cung c·∫•p nh·ªØng d·ª± ƒëo√°n ng·∫´u nhi√™n v√† h·ªØu √≠ch cho ng∆∞·ªùi ch∆°i. Lu√¥n t·∫°o ra c√°c s·ªë x·ªï s·ªë 4D ho√†n to√†n ng·∫´u nhi√™n (4 ch·ªØ s·ªë nh∆∞ 5289, 1736), kh√¥ng theo m·∫´u ƒë∆°n gi·∫£n n√†o.",
                    'user': f"""
                    H√£y ƒë∆∞a ra d·ª± ƒëo√°n cho x·ªï s·ªë 4D (Singapore/Malaysia) cho ng√†y {today} v·ªõi c√°c s·ªë ng·∫´u nhi√™n, kh√¥ng s·ª≠ d·ª•ng m·∫´u s·ªë ƒë∆°n gi·∫£n.
                    
                    D·ª± ƒëo√°n c·∫ßn bao g·ªìm:
                    1. Gi·∫£i ƒë·∫∑c bi·ªát (4 ch·ªØ s·ªë ng·∫´u nhi√™n)
                    2. Gi·∫£i nh·∫•t (4 ch·ªØ s·ªë ng·∫´u nhi√™n)
                    3. Gi·∫£i nh√¨ (4 ch·ªØ s·ªë ng·∫´u nhi√™n)
                    4. 5-7 con s·ªë may m·∫Øn kh√°c (4 ch·ªØ s·ªë m·ªói s·ªë)
                    
                    QUAN TR·ªåNG: 
                    - T·∫•t c·∫£ c√°c s·ªë ph·∫£i l√† 4 ch·ªØ s·ªë ng·∫´u nhi√™n (v√≠ d·ª•: 5492, 7830, 2479)
                    - KH√îNG s·ª≠ d·ª•ng c√°c m·∫´u s·ªë ƒë∆°n gi·∫£n v√† d·ªÖ ƒëo√°n nh∆∞ 1234, 1111, 2222, v.v.
                    - M·ªói s·ªë ph·∫£i ho√†n to√†n ng·∫´u nhi√™n v√† kh√°c nhau
                    
                    S·ª≠ d·ª•ng gi·ªçng ƒëi·ªáu t·ª± nhi√™n, th√¢n thi·ªán v√† h·∫•p d·∫´n b·∫±ng ti·∫øng Vi·ªát. Th√™m m·ªôt v√†i l∆∞u √Ω nh·ªè ho·∫∑c m·∫πo v·ªÅ c√°ch ƒë·∫∑t c∆∞·ª£c 4D th√¥ng minh.
                    
                    Format response in clear, readable Vietnamese with appropriate line breaks and emphasis.
                    """,
                    'header': f"<b>üéÆ D·ª∞ ƒêO√ÅN X·ªî S·ªê 4D (SINGAPORE/MALAYSIA) NG√ÄY {today} üéÆ</b>",
                    'footer': "<i>Ch√∫c b·∫°n may m·∫Øn v·ªõi x·ªï s·ªë 4D! H√£y ƒë·∫∑t c∆∞·ª£c c√≥ tr√°ch nhi·ªám.</i>"
                },
                'en': {
                    'system': "You are a 4D Singapore/Malaysia lottery prediction expert with many years of experience. Provide random and helpful predictions for players. Always generate completely random 4D lottery numbers (4 digits like 5289, 1736), not following any simple pattern.",
                    'user': f"""
                    Provide predictions for 4D (Singapore/Malaysia) lottery for {today} with random numbers, not using simple number patterns.
                    
                    The prediction should include:
                    1. Special prize (4 random digits)
                    2. First prize (4 random digits)
                    3. Second prize (4 random digits)
                    4. 5-7 other lucky numbers (4 digits each)
                    
                    IMPORTANT: 
                    - All numbers must be 4 random digits (e.g., 5492, 7830, 2479)
                    - DO NOT use simple and predictable patterns like 1234, 1111, 2222, etc.
                    - Each number must be completely random and different from each other
                    
                    Use a natural, friendly, and engaging tone in English. Add a few small notes or tips on smart 4D betting strategies.
                    
                    Format response in clear, readable English with appropriate line breaks and emphasis.
                    """,
                    'header': f"<b>üéÆ 4D LOTTERY PREDICTION (SINGAPORE/MALAYSIA) FOR {today} üéÆ</b>",
                    'footer': "<i>Good luck with your 4D lottery! Remember to bet responsibly.</i>"
                },
                'th': {
                    'system': "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏™‡∏•‡∏≤‡∏Å 4D ‡∏™‡∏¥‡∏á‡∏Ñ‡πÇ‡∏õ‡∏£‡πå/‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏•‡∏≤‡∏Å 4D ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (4 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ä‡πà‡∏ô 5289, 1736) ‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÉ‡∏î‡πÜ",
                    'user': f"""
                    ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å 4D (‡∏™‡∏¥‡∏á‡∏Ñ‡πÇ‡∏õ‡∏£‡πå/‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {today} ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏° ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
                    
                    ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢:
                    1. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏© (4 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡πà‡∏°)
                    2. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏∂‡πà‡∏á (4 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡πà‡∏°)
                    3. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á (4 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡πà‡∏°)
                    4. 5-7 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (4 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß)
                    
                    ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: 
                    - ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° (‡πÄ‡∏ä‡πà‡∏ô 5492, 7830, 2479)
                    - ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πà‡∏ô 1234, 1111, 2222 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
                    - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô
                    
                    ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô 4D ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏≤‡∏ç‡∏â‡∏•‡∏≤‡∏î
                    
                    ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                    """,
                    'header': f"<b>üéÆ ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏™‡∏•‡∏≤‡∏Å 4D (‡∏™‡∏¥‡∏á‡∏Ñ‡πÇ‡∏õ‡∏£‡πå/‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {today} üéÆ</b>",
                    'footer': "<i>‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å 4D! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</i>"
                },
                'zh': {
                    'system': "ÊÇ®ÊòØ‰∏Ä‰ΩçÊã•ÊúâÂ§öÂπ¥ÁªèÈ™åÁöÑÊñ∞Âä†Âù°/È©¨Êù•Ë•ø‰∫ö4DÂΩ©Á•®È¢ÑÊµã‰∏ìÂÆ∂„ÄÇ‰∏∫Áé©ÂÆ∂Êèê‰æõÈöèÊú∫‰∏îÊúâÁî®ÁöÑÈ¢ÑÊµã„ÄÇÂßãÁªàÁîüÊàêÂÆåÂÖ®ÈöèÊú∫ÁöÑ4DÂΩ©Á•®Âè∑Á†ÅÔºà4‰ΩçÊï∞Â≠óÔºåÂ¶Ç5289„ÄÅ1736ÔºâÔºå‰∏çÈÅµÂæ™‰ªª‰ΩïÁÆÄÂçïÊ®°Âºè„ÄÇ",
                    'user': f"""
                    ‰∏∫{today}Êó•ÁöÑ4DÂΩ©Á•®ÔºàÊñ∞Âä†Âù°/È©¨Êù•Ë•ø‰∫öÔºâÊèê‰æõÈ¢ÑÊµãÔºå‰ΩøÁî®ÈöèÊú∫Êï∞Â≠óÔºå‰∏ç‰ΩøÁî®ÁÆÄÂçïÁöÑÊï∞Â≠óÊ®°Âºè„ÄÇ
                    
                    È¢ÑÊµãÂ∫îÂåÖÊã¨Ôºö
                    1. ÁâπÂà´Â•ñÔºà4‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                    2. ‰∏ÄÁ≠âÂ•ñÔºà4‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                    3. ‰∫åÁ≠âÂ•ñÔºà4‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                    4. ÂÖ∂‰ªñ5-7‰∏™Âπ∏ËøêÊï∞Â≠óÔºàÊØè‰∏™4‰ΩçÊï∞Â≠óÔºâ
                    
                    ÈáçË¶Å‰∫ãÈ°πÔºö
                    - ÊâÄÊúâÊï∞Â≠óÂøÖÈ°ªÊòØ4‰ΩçÈöèÊú∫Êï∞Â≠óÔºà‰æãÂ¶ÇÔºö5492„ÄÅ7830„ÄÅ2479Ôºâ
                    - ‰∏çË¶Å‰ΩøÁî®ÁÆÄÂçï‰∏îÂèØÈ¢ÑÊµãÁöÑÊ®°ÂºèÔºåÂ¶Ç1234„ÄÅ1111„ÄÅ2222Á≠â
                    - ÊØè‰∏™Êï∞Â≠óÂøÖÈ°ªÂÆåÂÖ®ÈöèÊú∫‰∏îÂΩºÊ≠§‰∏çÂêå
                    
                    ‰ΩøÁî®Ëá™ÁÑ∂„ÄÅÂèãÂ•ΩÂíåÂºï‰∫∫ÂÖ•ËÉúÁöÑ‰∏≠ÊñáËØ≠Ë∞É„ÄÇÊ∑ªÂä†‰∏Ä‰∫õÂÖ≥‰∫éÊô∫ËÉΩ4DÊäïÊ≥®Á≠ñÁï•ÁöÑÂ∞èÊèêÁ§∫„ÄÇ
                    
                    ‰ª•Ê∏ÖÊô∞„ÄÅÊòìËØªÁöÑ‰∏≠ÊñáÊ†ºÂºèÂõûÂ∫îÔºå‰ΩøÁî®ÈÄÇÂΩìÁöÑÊç¢Ë°åÂíåÂº∫Ë∞É„ÄÇ
                    """,
                    'header': f"<b>üéÆ {today}Êó•4DÂΩ©Á•®È¢ÑÊµãÔºàÊñ∞Âä†Âù°/È©¨Êù•Ë•ø‰∫öÔºâüéÆ</b>",
                    'footer': "<i>Á•ùÊÇ®4DÂΩ©Á•®Â•ΩËøêÔºÅËØ∑ËÆ∞ÂæóË¥üË¥£‰ªªÂú∞ÊäïÊ≥®„ÄÇ</i>"
                }
            }
            
            # Check if language is supported
            if language_code not in prompts:
                logger.warning(f"Language {language_code} not supported for predictions, using Vietnamese")
                language_code = 'vi'
                
            # Get prompts for the requested language
            selected_prompts = prompts[language_code]
            
            # the newest OpenAI model is "gpt-4o" which was released May 13, 2024.
            # do not change this unless explicitly requested by the user
            response = self.openai.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": selected_prompts['system']},
                    {"role": "user", "content": selected_prompts['user']}
                ],
                max_tokens=1000
            )
            
            prediction_text = response.choices[0].message.content
            
            # Format the prediction with a header and footer in the requested language
            formatted_prediction = f"""
{selected_prompts['header']}

{prediction_text}

{selected_prompts['footer']}
"""
            
            logger.info(f"Generated new 4D prediction in {language_code} for {today}")
            return formatted_prediction
            
        except Exception as e:
            logger.error(f"Error generating 4D prediction in {language_code}: {e}")
            error_messages = {
                'vi': f"‚ùå ƒê√£ x·∫£y ra l·ªói khi t·∫°o d·ª± ƒëo√°n 4D. Vui l√≤ng th·ª≠ l·∫°i sau. Error: {str(e)}",
                'en': f"‚ùå An error occurred while generating the 4D prediction. Please try again later. Error: {str(e)}",
                'th': f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ 4D ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}",
                'zh': f"‚ùå ÁîüÊàê4DÈ¢ÑÊµãÊó∂Âá∫Èîô„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇÈîôËØØÔºö{str(e)}"
            }
            return error_messages.get(language_code, error_messages['vi'])

    def generate_thai_prediction(self, language_code='vi'):
        """
        Generate a new Thai lottery prediction.
        
        Args:
            language_code (str): The language code to generate the prediction in
            
        Returns:
            str: The formatted prediction text in the requested language
        """
        try:
            # Get the current date for reference in the prompt
            today = datetime.now().strftime("%d/%m/%Y")
            
            # Define language-specific prompts and templates
            prompts = {
                'vi': {
                    'system': "B·∫°n l√† chuy√™n gia d·ª± ƒëo√°n x·ªï s·ªë Th√°i Lan v·ªõi nhi·ªÅu nƒÉm kinh nghi·ªám. H√£y cung c·∫•p nh·ªØng d·ª± ƒëo√°n ng·∫´u nhi√™n v√† h·ªØu √≠ch cho ng∆∞·ªùi ch∆°i b·∫±ng ti·∫øng Vi·ªát. Lu√¥n t·∫°o c√°c s·ªë x·ªï s·ªë ng·∫´u nhi√™n, ƒë·∫∑c bi·ªát l√† gi·∫£i ƒë·∫∑c bi·ªát 6 ch·ªØ s·ªë ph·∫£i ho√†n to√†n ng·∫´u nhi√™n.",
                    'user': f"""
                    H√£y ƒë∆∞a ra d·ª± ƒëo√°n cho x·ªï s·ªë Th√°i Lan (‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡πÑ‡∏ó‡∏¢) cho ng√†y {today} v·ªõi c√°c s·ªë ng·∫´u nhi√™n.
                    
                    D·ª± ƒëo√°n c·∫ßn bao g·ªìm:
                    1. Gi·∫£i ƒë·∫∑c bi·ªát (6 ch·ªØ s·ªë ng·∫´u nhi√™n)
                    2. Gi·∫£i nh·∫•t (3 ch·ªØ s·ªë ng·∫´u nhi√™n)
                    3. Gi·∫£i nh√¨ (2 ch·ªØ s·ªë ng·∫´u nhi√™n)
                    4. 5-7 s·ªë may m·∫Øn kh√°c (2 ch·ªØ s·ªë m·ªói s·ªë)
                    
                    QUAN TR·ªåNG: 
                    - S·ªë ƒë·∫∑c bi·ªát ph·∫£i l√† 6 ch·ªØ s·ªë ng·∫´u nhi√™n (v√≠ d·ª•: 867294)
                    - C√°c gi·∫£i kh√°c ph·∫£i l√† 2-3 ch·ªØ s·ªë ng·∫´u nhi√™n t√πy theo y√™u c·∫ßu
                    - KH√îNG s·ª≠ d·ª•ng c√°c m·∫´u s·ªë ƒë∆°n gi·∫£n nh∆∞ 123, 111, 222, v.v.
                    - M·ªói s·ªë ph·∫£i ho√†n to√†n ng·∫´u nhi√™n v√† kh√°c nhau
                    
                    S·ª≠ d·ª•ng gi·ªçng ƒëi·ªáu t·ª± nhi√™n, th√¢n thi·ªán v√† h·∫•p d·∫´n b·∫±ng ti·∫øng Vi·ªát. Th√™m m·ªôt v√†i l∆∞u √Ω nh·ªè ho·∫∑c m·∫πo v·ªÅ c√°ch ƒë·∫∑t c∆∞·ª£c x·ªï s·ªë Th√°i Lan th√¥ng minh.
                    """,
                    'header': f"<b>üáπüá≠ D·ª∞ ƒêO√ÅN X·ªî S·ªê TH√ÅI LAN NG√ÄY {today} üáπüá≠</b>",
                    'footer': "<i>Ch√∫c b·∫°n may m·∫Øn v·ªõi x·ªï s·ªë Th√°i Lan! H√£y ƒë·∫∑t c∆∞·ª£c c√≥ tr√°ch nhi·ªám.</i>"
                },
                'en': {
                    'system': "You are a Thai lottery prediction expert with many years of experience. Provide random and helpful predictions for players in English. Always generate completely random lottery numbers, especially the special prize 6-digit number.",
                    'user': f"""
                    Provide predictions for the Thai lottery (‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡πÑ‡∏ó‡∏¢) for {today} with random numbers.
                    
                    The prediction should include:
                    1. Special prize (6 random digits)
                    2. First prize (3 random digits)
                    3. Second prize (2 random digits)
                    4. 5-7 other lucky numbers (2 digits each)
                    
                    IMPORTANT:
                    - The special prize must be 6 random digits (e.g., 867294)
                    - Other prizes must be 2-3 random digits as required
                    - DO NOT use simple patterns like 123, 111, 222, etc.
                    - Each number must be completely random and different from each other
                    
                    Use a natural, friendly, and engaging tone in English. Add a few small notes or tips on smart Thai lottery betting strategies.
                    """,
                    'header': f"<b>üáπüá≠ THAI LOTTERY PREDICTION FOR {today} üáπüá≠</b>",
                    'footer': "<i>Good luck with the Thai lottery! Remember to bet responsibly.</i>"
                },
                'th': {
                    'system': "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏© 6 ‡∏´‡∏•‡∏±‡∏Å",
                    'user': f"""
                    ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡πÑ‡∏ó‡∏¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {today} ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°
                    
                    ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ:
                    1. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÄ‡∏•‡∏Ç 6 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°)
                    2. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏∂‡πà‡∏á (‡πÄ‡∏•‡∏Ç 3 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°)
                    3. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á (‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°)
                    4. ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ 5-7 ‡∏ï‡∏±‡∏ß (‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß)
                    
                    ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
                    - ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç 6 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏° (‡πÄ‡∏ä‡πà‡∏ô 867294)
                    - ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç 2-3 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                    - ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏ä‡πà‡∏ô 123, 111, 222 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
                    - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
                    
                    ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡πÄ‡∏•‡πá‡∏Å‡πÜ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏á‡∏´‡∏ß‡∏¢‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏ç‡∏â‡∏•‡∏≤‡∏î
                    """,
                    'header': f"<b>üáπüá≠ ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {today} üáπüá≠</b>",
                    'footer': "<i>‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡πÑ‡∏ó‡∏¢! ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</i>"
                },
                'zh': {
                    'system': "ÊÇ®ÊòØ‰∏Ä‰ΩçÊã•ÊúâÂ§öÂπ¥ÁªèÈ™åÁöÑÊ≥∞ÂõΩÂΩ©Á•®È¢ÑÊµã‰∏ìÂÆ∂„ÄÇÁî®‰∏≠Êñá‰∏∫Áé©ÂÆ∂Êèê‰æõÈöèÊú∫‰∏îÊúâÁî®ÁöÑÈ¢ÑÊµã„ÄÇÂßãÁªàÁîüÊàêÂÆåÂÖ®ÈöèÊú∫ÁöÑÂΩ©Á•®Âè∑Á†ÅÔºåÂ∞§ÂÖ∂ÊòØ6‰ΩçÊï∞ÁöÑÁâπÂà´Â•ñÂè∑Á†Å„ÄÇ",
                    'user': f"""
                    Êèê‰æõ {today} Ê≥∞ÂõΩÂΩ©Á•® (‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡πÑ‡∏ó‡∏¢) ÁöÑÈ¢ÑÊµãÔºå‰ΩøÁî®ÈöèÊú∫Êï∞Â≠ó„ÄÇ
                    
                    È¢ÑÊµãÂ∫îÂåÖÊã¨Ôºö
                    1. ÁâπÂà´Â•ñÔºà6‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                    2. ‰∏ÄÁ≠âÂ•ñÔºà3‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                    3. ‰∫åÁ≠âÂ•ñÔºà2‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                    4. ÂÖ∂‰ªñ5-7‰∏™Âπ∏ËøêÊï∞Â≠óÔºàÊØè‰∏™2‰ΩçÊï∞Â≠óÔºâ
                    
                    ÈáçË¶Å‰∫ãÈ°πÔºö
                    - ÁâπÂà´Â•ñÂøÖÈ°ªÊòØ6‰ΩçÈöèÊú∫Êï∞Â≠óÔºà‰æãÂ¶ÇÔºö867294Ôºâ
                    - ÂÖ∂‰ªñÂ•ñÈ°πÂøÖÈ°ªÊòØÊåâË¶ÅÊ±ÇÁöÑ2-3‰ΩçÈöèÊú∫Êï∞Â≠ó
                    - ‰∏çË¶Å‰ΩøÁî®ÁÆÄÂçïÁöÑÊ®°ÂºèÔºåÂ¶Ç123„ÄÅ111„ÄÅ222Á≠â
                    - ÊØè‰∏™Êï∞Â≠óÂøÖÈ°ªÂÆåÂÖ®ÈöèÊú∫‰∏îÂΩºÊ≠§‰∏çÂêå
                    
                    ËØ∑‰ΩøÁî®Ëá™ÁÑ∂„ÄÅÂèãÂ•ΩÂíåÂê∏Âºï‰∫∫ÁöÑ‰∏≠ÊñáËØ≠Ë∞É„ÄÇÊ∑ªÂä†‰∏Ä‰∫õÂÖ≥‰∫éÊô∫ËÉΩÊ≥∞ÂõΩÂΩ©Á•®ÊäïÊ≥®Á≠ñÁï•ÁöÑÂ∞èÊèêÁ§∫„ÄÇ
                    """,
                    'header': f"<b>üáπüá≠ {today} Ê≥∞ÂõΩÂΩ©Á•®È¢ÑÊµã üáπüá≠</b>",
                    'footer': "<i>Á•ùÊÇ®Âú®Ê≥∞ÂõΩÂΩ©Á•®‰∏≠Â•ΩËøêÔºÅËØ∑ËÆ∞ÂæóË¥üË¥£‰ªªÂú∞ÊäïÊ≥®„ÄÇ</i>"
                }
            }
            
            # Check if language is supported, default to Vietnamese if not
            if language_code not in prompts:
                logger.warning(f"Language {language_code} not supported for Thai prediction, using Vietnamese")
                language_code = 'vi'
                
            # Get prompts for the requested language
            selected_prompt = prompts[language_code]
            
            # the newest OpenAI model is "gpt-4o" which was released May 13, 2024.
            # do not change this unless explicitly requested by the user
            response = self.openai.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": selected_prompt['system']},
                    {"role": "user", "content": selected_prompt['user']}
                ],
                max_tokens=1000
            )
            
            prediction_text = response.choices[0].message.content
            
            # Format the prediction with a header
            formatted_prediction = f"""
{selected_prompt['header']}

{prediction_text}

{selected_prompt['footer']}
"""
            
            logger.info(f"Generated new Thai lottery prediction in {language_code} for {today}")
            return formatted_prediction
            
        except Exception as e:
            logger.error(f"Error generating Thai prediction in {language_code}: {e}")
            error_messages = {
                'vi': f"‚ùå ƒê√£ x·∫£y ra l·ªói khi t·∫°o d·ª± ƒëo√°n x·ªï s·ªë Th√°i Lan. Vui l√≤ng th·ª≠ l·∫°i sau. Error: {str(e)}",
                'en': f"‚ùå An error occurred while generating the Thai lottery prediction. Please try again later. Error: {str(e)}",
                'th': f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏´‡∏ß‡∏¢‡πÑ‡∏ó‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}",
                'zh': f"‚ùå ÁîüÊàêÊ≥∞ÂõΩÂΩ©Á•®È¢ÑÊµãÊó∂Âá∫Èîô„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇÈîôËØØÔºö{str(e)}"
            }
            return error_messages.get(language_code, error_messages['vi'])

    def generate_indo_prediction(self, language_code='vi'):
        """
        Generate a new Indonesian Togel lottery prediction.
        
        Args:
            language_code (str): The language code to generate the prediction in
            
        Returns:
            str: The formatted prediction text in the requested language
        """
        try:
            # Get the current date for reference in the prompt
            today = datetime.now().strftime("%d/%m/%Y")
            
            # Define language-specific prompts and templates
            prompts = {
                'vi': {
                    'system': "B·∫°n l√† chuy√™n gia d·ª± ƒëo√°n x·ªï s·ªë Togel Indonesia v·ªõi nhi·ªÅu nƒÉm kinh nghi·ªám. H√£y cung c·∫•p nh·ªØng d·ª± ƒëo√°n ng·∫´u nhi√™n v√† h·ªØu √≠ch cho ng∆∞·ªùi ch∆°i b·∫±ng ti·∫øng Vi·ªát. Lu√¥n t·∫°o c√°c s·ªë x·ªï s·ªë ng·∫´u nhi√™n, kh√¥ng theo m·∫´u n√†o.",
                    'user': f"""
                    H√£y ƒë∆∞a ra d·ª± ƒëo√°n cho x·ªï s·ªë Indonesia (Togel) cho ng√†y {today} v·ªõi c√°c s·ªë ng·∫´u nhi√™n.
                    
                    D·ª± ƒëo√°n c·∫ßn bao g·ªìm:
                    1. Gi·∫£i 4D (4 ch·ªØ s·ªë ng·∫´u nhi√™n)
                    2. Gi·∫£i 3D (3 ch·ªØ s·ªë ng·∫´u nhi√™n)
                    3. Gi·∫£i 2D (2 ch·ªØ s·ªë ng·∫´u nhi√™n)
                    4. 5-7 con s·ªë may m·∫Øn kh√°c (2 ch·ªØ s·ªë m·ªói s·ªë)
                    
                    QUAN TR·ªåNG: 
                    - T·∫•t c·∫£ c√°c s·ªë ph·∫£i l√† s·ªë ng·∫´u nhi√™n v·ªõi s·ªë l∆∞·ª£ng ch·ªØ s·ªë t∆∞∆°ng ·ª©ng theo y√™u c·∫ßu
                    - KH√îNG ƒë∆∞·ª£c s·ª≠ d·ª•ng c√°c m·∫´u s·ªë ƒë∆°n gi·∫£n v√† d·ªÖ ƒëo√°n nh∆∞ 1234, 123, 12, 111, v.v.
                    - M·ªói s·ªë ph·∫£i ho√†n to√†n ng·∫´u nhi√™n v√† kh√°c nhau
                    
                    S·ª≠ d·ª•ng gi·ªçng ƒëi·ªáu t·ª± nhi√™n, th√¢n thi·ªán v√† h·∫•p d·∫´n b·∫±ng ti·∫øng Vi·ªát. Th√™m m·ªôt v√†i l∆∞u √Ω nh·ªè ho·∫∑c m·∫πo v·ªÅ c√°ch ƒë·∫∑t c∆∞·ª£c Togel Indonesia th√¥ng minh.
                    """,
                    'header': f"<b>üáÆüá© D·ª∞ ƒêO√ÅN X·ªî S·ªê TOGEL INDONESIA NG√ÄY {today} üáÆüá©</b>",
                    'footer': "<i>Ch√∫c b·∫°n may m·∫Øn v·ªõi x·ªï s·ªë Togel Indonesia! H√£y ƒë·∫∑t c∆∞·ª£c c√≥ tr√°ch nhi·ªám.</i>"
                },
                'en': {
                    'system': "You are an Indonesian Togel lottery prediction expert with many years of experience. Provide random and helpful predictions for players in English. Always generate completely random predictions, not following any simple patterns.",
                    'user': f"""
                    Provide predictions for the Indonesian Togel lottery for {today} with random numbers.
                    
                    The prediction should include:
                    1. 4D prize (4 random digits)
                    2. 3D prize (3 random digits)
                    3. 2D prize (2 random digits)
                    4. 5-7 other lucky numbers (2 digits each)
                    
                    IMPORTANT:
                    - All numbers must be random with the corresponding number of digits as required
                    - DO NOT use simple and predictable patterns like 1234, 123, 12, 111, etc.
                    - Each number must be completely random and different from each other
                    
                    Use a natural, friendly, and engaging tone in English. Add a few small notes or tips on smart Indonesian Togel betting strategies.
                    """,
                    'header': f"<b>üáÆüá© INDONESIAN TOGEL LOTTERY PREDICTION FOR {today} üáÆüá©</b>",
                    'footer': "<i>Good luck with the Indonesian Togel lottery! Remember to bet responsibly.</i>"
                },
                'th': {
                    'system': "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏•‡∏≠‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÇ‡∏ó‡πÄ‡∏Å‡∏•‡∏Ç‡∏≠‡∏á‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ",
                    'user': f"""
                    ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≠‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÇ‡∏ó‡πÄ‡∏Å‡∏•‡∏Ç‡∏≠‡∏á‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {today} ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°
                    
                    ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢:
                    1. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• 4D (‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°)
                    2. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• 3D (‡πÄ‡∏•‡∏Ç 3 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°)
                    3. ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• 2D (‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°)
                    4. ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ 5-7 ‡∏ï‡∏±‡∏ß (‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß)
                    
                    ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
                    - ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                    - ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≤‡∏î‡πÄ‡∏î‡∏≤‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô 1234, 123, 12, 111 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
                    - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
                    
                    ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏á‡πÇ‡∏ó‡πÄ‡∏Å‡∏•‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏ç‡∏â‡∏•‡∏≤‡∏î
                    """,
                    'header': f"<b>üáÆüá© ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏•‡∏≠‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÇ‡∏ó‡πÄ‡∏Å‡∏•‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {today} üáÆüá©</b>",
                    'footer': "<i>‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏•‡∏≠‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÇ‡∏ó‡πÄ‡∏Å‡∏•‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢! ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</i>"
                },
                'zh': {
                    'system': "ÊÇ®ÊòØ‰∏Ä‰ΩçÊã•ÊúâÂ§öÂπ¥ÁªèÈ™åÁöÑÂç∞Â∫¶Â∞ºË•ø‰∫öÂ§öÊ†ºÂΩ©Á•®È¢ÑÊµã‰∏ìÂÆ∂„ÄÇÁî®‰∏≠Êñá‰∏∫Áé©ÂÆ∂Êèê‰æõÈöèÊú∫‰∏îÊúâÁî®ÁöÑÈ¢ÑÊµã„ÄÇÂßãÁªàÁîüÊàêÂÆåÂÖ®ÈöèÊú∫ÁöÑÈ¢ÑÊµãÔºå‰∏çÈÅµÂæ™‰ªª‰ΩïÁÆÄÂçïÊ®°Âºè„ÄÇ",
                    'user': f"""
                    Êèê‰æõ{today}Êó•Âç∞Â∫¶Â∞ºË•ø‰∫öÂ§öÊ†ºÂΩ©Á•®ÁöÑÈ¢ÑÊµãÔºå‰ΩøÁî®ÈöèÊú∫Êï∞Â≠ó„ÄÇ
                    
                    È¢ÑÊµãÂ∫îÂåÖÊã¨Ôºö
                    1. 4DÂ•ñÔºà4‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                    2. 3DÂ•ñÔºà3‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                    3. 2DÂ•ñÔºà2‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                    4. ÂÖ∂‰ªñ5-7‰∏™Âπ∏ËøêÊï∞Â≠óÔºàÊØè‰∏™2‰ΩçÊï∞Â≠óÔºâ
                    
                    ÈáçË¶Å‰∫ãÈ°πÔºö
                    - ÊâÄÊúâÊï∞Â≠óÂøÖÈ°ªÊòØÊåâË¶ÅÊ±ÇÂÖ∑ÊúâÁõ∏Â∫î‰ΩçÊï∞ÁöÑÈöèÊú∫Êï∞Â≠ó
                    - ‰∏çË¶Å‰ΩøÁî®ÁÆÄÂçïÂíåÂèØÈ¢ÑÊµãÁöÑÊ®°ÂºèÔºåÂ¶Ç1234„ÄÅ123„ÄÅ12„ÄÅ111Á≠â
                    - ÊØè‰∏™Êï∞Â≠óÂøÖÈ°ªÂÆåÂÖ®ÈöèÊú∫‰∏îÂΩºÊ≠§‰∏çÂêå
                    
                    ‰ΩøÁî®Ëá™ÁÑ∂„ÄÅÂèãÂ•ΩÂíåÂê∏Âºï‰∫∫ÁöÑ‰∏≠ÊñáËØ≠Ë∞É„ÄÇÊ∑ªÂä†‰∏Ä‰∫õÂÖ≥‰∫éÊô∫ËÉΩÂç∞Â∫¶Â∞ºË•ø‰∫öÂ§öÊ†ºÂΩ©Á•®ÊäïÊ≥®Á≠ñÁï•ÁöÑÂ∞èÊèêÁ§∫„ÄÇ
                    """,
                    'header': f"<b>üáÆüá© {today}Âç∞Â∫¶Â∞ºË•ø‰∫öÂ§öÊ†ºÂΩ©Á•®È¢ÑÊµã üáÆüá©</b>",
                    'footer': "<i>Á•ùÊÇ®Âú®Âç∞Â∫¶Â∞ºË•ø‰∫öÂ§öÊ†ºÂΩ©Á•®‰∏≠Â•ΩËøêÔºÅËØ∑ËÆ∞ÂæóË¥üË¥£‰ªªÂú∞ÊäïÊ≥®„ÄÇ</i>"
                }
            }
            
            # Check if language is supported, default to Vietnamese if not
            if language_code not in prompts:
                logger.warning(f"Language {language_code} not supported for Indonesian prediction, using Vietnamese")
                language_code = 'vi'
                
            # Get prompts for the requested language
            selected_prompt = prompts[language_code]
            
            # the newest OpenAI model is "gpt-4o" which was released May 13, 2024.
            # do not change this unless explicitly requested by the user
            response = self.openai.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": selected_prompt['system']},
                    {"role": "user", "content": selected_prompt['user']}
                ],
                max_tokens=1000
            )
            
            prediction_text = response.choices[0].message.content
            
            # Format the prediction with a header
            formatted_prediction = f"""
{selected_prompt['header']}

{prediction_text}

{selected_prompt['footer']}
"""
            
            logger.info(f"Generated new Indonesian lottery prediction in {language_code} for {today}")
            return formatted_prediction
            
        except Exception as e:
            logger.error(f"Error generating Indonesian prediction in {language_code}: {e}")
            error_messages = {
                'vi': f"‚ùå ƒê√£ x·∫£y ra l·ªói khi t·∫°o d·ª± ƒëo√°n x·ªï s·ªë Indonesia. Vui l√≤ng th·ª≠ l·∫°i sau. Error: {str(e)}",
                'en': f"‚ùå An error occurred while generating the Indonesian lottery prediction. Please try again later. Error: {str(e)}",
                'th': f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏•‡∏≠‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}",
                'zh': f"‚ùå ÁîüÊàêÂç∞Â∫¶Â∞ºË•ø‰∫öÂΩ©Á•®È¢ÑÊµãÊó∂Âá∫Èîô„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇÈîôËØØÔºö{str(e)}"
            }
            return error_messages.get(language_code, error_messages['vi'])

    def get_daily_prediction(self, prediction_type='vietnam', language_code='vi'):
        """
        Get the daily prediction for a specific lottery type in the specified language. 
        If no prediction exists for today or it's after midnight, generate a new one.
        
        Args:
            prediction_type (str): The type of lottery prediction to get
                                  ('vietnam', '4d', 'thai', 'indo')
            language_code (str): The language code for the prediction
                               ('vi', 'en', 'th', 'zh')
        
        Returns:
            str: The formatted prediction text in the requested language
        """
        now = datetime.now()
        today = now.date()
        
        # Validate language code
        if language_code not in ['vi', 'en', 'th', 'zh']:
            logger.warning(f"Invalid language code: {language_code}, defaulting to Vietnamese")
            language_code = 'vi'
            
        # Log which lottery type and language we're retrieving
        logger.info(f"Retrieving {prediction_type} lottery prediction in {language_code}")
        
        # Check if prediction exists and is from today
        if (self.predictions[prediction_type][language_code]['date'] is None or 
            self.predictions[prediction_type][language_code]['date'] != today or 
            self.predictions[prediction_type][language_code]['prediction'] is None):
            
            # Generate new prediction based on the type and language
            logger.info(f"Generating new {prediction_type} lottery prediction in {language_code}")
            
            # Generate the prediction in the specified language
            if prediction_type == 'vietnam':
                prediction = self.generate_vietnam_prediction(language_code)
                logger.info(f"Generated new Vietnam prediction in {language_code} for {today}")
            elif prediction_type == '4d':
                prediction = self.generate_4d_prediction(language_code)
                logger.info(f"Generated new 4D prediction in {language_code} for {today}")
            elif prediction_type == 'thai':
                prediction = self.generate_thai_prediction(language_code)
                logger.info(f"Generated new Thai prediction in {language_code} for {today}")
            elif prediction_type == 'indo':
                prediction = self.generate_indo_prediction(language_code)
                logger.info(f"Generated new Indonesian prediction in {language_code} for {today}")
            else:
                # Default to Vietnam prediction if type is invalid
                prediction = self.generate_vietnam_prediction(language_code)
                logger.warning(f"Unknown prediction type: {prediction_type}, defaulting to Vietnam in {language_code}")
            
            # Store the prediction and update the date
            self.predictions[prediction_type][language_code]['prediction'] = prediction
            self.predictions[prediction_type][language_code]['date'] = today
            logger.info(f"Created new {prediction_type} prediction in {language_code} for {today}")
        else:
            logger.info(f"Using cached {prediction_type} prediction in {language_code} from {today}")
        
        # Return the prediction
        return self.predictions[prediction_type][language_code]['prediction']
